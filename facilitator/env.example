# x402-exec Facilitator Configuration
# Copy this file to .env and fill in your values

# =====================================
# Multi-Account Configuration (Recommended)
# =====================================
# Three configuration methods supported (in priority order):

# Method 1: Comma-separated (Recommended ⭐ - Most concise)
# Advantages: Simple config, easy to read, straightforward
# Example: 5 EVM accounts for parallel processing
EVM_PRIVATE_KEYS=0xkey1,0xkey2,0xkey3,0xkey4,0xkey5

# Method 2: Numeric suffix (Alternative - Suitable for K8s Secrets)
# Advantages: Easy for Kubernetes Secrets management, selective configuration
# EVM_PRIVATE_KEY_1=0x...
# EVM_PRIVATE_KEY_2=0x...
# EVM_PRIVATE_KEY_3=0x...
# EVM_PRIVATE_KEY_4=0x...
# EVM_PRIVATE_KEY_5=0x...

# Method 3: Single account (Backward compatibility)
# EVM_PRIVATE_KEY=0x...

# Notes:
# - Priority: EVM_PRIVATE_KEYS > EVM_PRIVATE_KEY_* > EVM_PRIVATE_KEY
# - Program automatically detects and uses the first found configuration
# - Recommended: comma-separated for local dev, numeric suffix for K8s deployment
# - Suggested: 5 accounts, each processes serially to avoid nonce conflicts, parallel across 5 accounts for optimal throughput

# =====================================
# Account Pool Configuration
# =====================================
# Account selection strategy
ACCOUNT_SELECTION_STRATEGY=round_robin  # round_robin (round-robin) | random (random)

# Whether to wait for transaction confirmation (affects throughput)
# true: Wait for confirmation before returning (reliable, throughput ~0.4 TPS)
# false: Return immediately after sending transaction (throughput ~10 TPS, but requires async monitoring)
# WAIT_FOR_TX_CONFIRMATION=true

# =====================================
# Cache Configuration
# =====================================
# Enable caching
CACHE_ENABLED=true

# Token version cache TTL (seconds)
# Token contract versions rarely change, can use longer TTL
CACHE_TTL_TOKEN_VERSION=3600

# Token metadata cache TTL (seconds)
# Token name, symbol, decimals, etc.
CACHE_TTL_TOKEN_METADATA=3600

# Maximum number of cache keys
# Limits cache size to prevent excessive memory usage
CACHE_MAX_KEYS=1000

# =====================================
# Gas Monitoring Configuration
# =====================================
# Minimum gas balance (ETH)
# When below this value, /ready endpoint reports unhealthy account
MINIMUM_GAS_BALANCE=0.1

# Gas alert threshold (ETH)
# Trigger alert when below this value (requires external monitoring system)
GAS_ALERT_THRESHOLD=0.05

# =====================================
# SettlementRouter Address (Whitelist)
# =====================================
# Configuration priority: Environment variables > x402x core defaults
# 
# Supported networks are automatically retrieved from x402x core package, no manual configuration needed
# 
# Testnet defaults (from x402x core, no configuration needed):
#   - base-sepolia: 0x32431D4511e061F1133520461B07eC42afF157D6
#   - x-layer-testnet: 0x1ae0e196dc18355af3a19985faf67354213f833d
# 
# Mainnet requires manual configuration after contract deployment (overrides defaults):
# BASE_SETTLEMENT_ROUTER_ADDRESS=0x...
# X_LAYER_SETTLEMENT_ROUTER_ADDRESS=0x...
#
# Environment variable naming convention: {NETWORK}_SETTLEMENT_ROUTER_ADDRESS
# Example: BASE_SEPOLIA_SETTLEMENT_ROUTER_ADDRESS

# =====================================
# Mainnet Security Policy
# =====================================
# ⚠️ Important: Settlement mode restrictions for mainnet vs testnet
# 
# Mainnet:
#   - Standard x402 settlement disabled (no API key protection, attack risk exists)
#   - Only SettlementRouter (x402x) settlement allowed
#   - Must configure facilitatorFee to protect facilitator
# 
# Testnet:
#   - Supports both standard x402 and x402x settlement modes
#   - Suitable for testing and development
#
# Program automatically detects based on network name (contains sepolia/testnet/fuji/amoy etc. = testnet)


# =====================================
# Server Configuration
# =====================================
PORT=3000

# Request body size limit (prevents oversized requests)
# Default 1MB, adjust based on actual needs
REQUEST_BODY_LIMIT=1mb

# =====================================
# Rate Limiting Configuration (Recommended for production)
# =====================================
# Enable rate limiting (default: true)
# Can be set to false for dev environments, strongly recommended for production
RATE_LIMIT_ENABLED=true

# Rate limit for /verify endpoint (max requests per time window)
# Default: 100 req/min per IP
RATE_LIMIT_VERIFY_MAX=100

# Rate limit for /settle endpoint (max requests per time window)
# Default: 20 req/min per IP
# Settle operations are more resource-intensive, so the limit is stricter
RATE_LIMIT_SETTLE_MAX=20

# Rate limit time window (milliseconds)
# Default: 60000ms (1 minute)
RATE_LIMIT_WINDOW_MS=60000

# =====================================
# Gas Cost Validation & Hook Security
# =====================================
# Minimum facilitator fee validation to prevent gas cost coverage issues
# Also defends against gas attacks from malicious Hooks

# Enable gas cost validation (default: true, strongly recommended)
GAS_COST_VALIDATION_ENABLED=true

# Base gas limit (baseline overhead for all settlements)
# Default: 150000 gas (includes router calls, token transfers, and other basic operations)
GAS_COST_BASE_LIMIT=150000

# Additional gas overhead per Hook type
# TransferHook: ~50k gas (simple transfer)
GAS_COST_HOOK_TRANSFER_OVERHEAD=50000
# Custom Hook: ~100k gas (custom logic, conservative estimate)
GAS_COST_HOOK_CUSTOM_OVERHEAD=100000

# Safety multiplier (to handle gas price fluctuations)
# 1.5x = 150% fee requirement, provides buffer for gas price volatility
# Recommended 1.3-1.5 for production, can set 2.0 for testing
GAS_COST_SAFETY_MULTIPLIER=1.5

# Maximum gas limit per transaction (prevents malicious Hooks)
# Transactions exceeding this limit will be rejected
# Default: 500000 gas (sufficient for common Hooks while preventing attacks)
GAS_COST_MAX_GAS_LIMIT=500000

# =====================================
# Hook Whitelist (Security Protection)
# =====================================
# Enable Hook whitelist (default: false, recommended for production)
# When enabled, only whitelisted Hooks are accepted, preventing malicious Hook attacks
# HOOK_WHITELIST_ENABLED=true

# Allowed Hook addresses per network (comma-separated for multiple addresses)
# TransferHook from network config is automatically included by default
# When adding custom Hooks, ensure they have been audited
# BASE_SEPOLIA_ALLOWED_HOOKS=0x6b486aF5A08D27153d0374BE56A1cB1676c460a8
# X_LAYER_TESTNET_ALLOWED_HOOKS=0x3D07D4E03a2aDa2EC49D6937ab1B40a83F3946AB

# Mainnet Hook whitelist (configure after deployment)
# BASE_ALLOWED_HOOKS=0x...
# X_LAYER_ALLOWED_HOOKS=0x...

# =====================================
# Network Gas Price Configuration (for fee calculation)
# =====================================
# Target gas price per network (wei)
# Used to calculate minimum facilitator fee
# Recommended to set at or slightly above network average gas price

# Base Sepolia (testnet)
BASE_SEPOLIA_TARGET_GAS_PRICE=1000000000  # 1 gwei (testnet gas is cheap)

# X-Layer Testnet
X_LAYER_TESTNET_TARGET_GAS_PRICE=100000000  # 0.1 gwei (very low for testnet)

# Mainnet gas prices (configure based on actual conditions)
# BASE_TARGET_GAS_PRICE=50000000000  # 50 gwei
# X_LAYER_TARGET_GAS_PRICE=1000000000  # 1 gwei

# =====================================
# Native Token Price Configuration (USD)
# =====================================
# Used to convert gas costs (native token) to USD, then to USDC
# Recommended to update periodically (daily or weekly) to reflect market prices

# Base Sepolia / Base (ETH)
BASE_SEPOLIA_ETH_PRICE=3000  # $3000/ETH
# BASE_ETH_PRICE=3000

# X-Layer (OKB)
X_LAYER_TESTNET_ETH_PRICE=50  # $50/OKB (testnet, same as mainnet price)
# X_LAYER_ETH_PRICE=50  # Mainnet OKB price

# =====================================
# Dynamic Token Price Configuration (Optional)
# =====================================
# Enable dynamic token price fetching from CoinGecko API (enabled by default)
# If disabled, will use static prices configured above
TOKEN_PRICE_ENABLED=true

# Token price cache TTL (seconds, default: 3600 = 1 hour)
# TOKEN_PRICE_CACHE_TTL=3600

# Background update interval (seconds, default: 600 = 10 minutes)
# TOKEN_PRICE_UPDATE_INTERVAL=600

# CoinGecko Pro API key (optional, increases rate limits)
# Free tier: 50 calls/minute
# Pro tier: 500 calls/minute ($129/month)
# Get your key at: https://www.coingecko.com/en/api/pricing
# COINGECKO_API_KEY=your_api_key_here

# Custom CoinGecko coin IDs (optional, uses defaults if not specified)
# Defaults:
#   base-sepolia/base -> ethereum
#   x-layer-testnet/x-layer -> okb
# BASE_SEPOLIA_COIN_ID=ethereum
# X_LAYER_TESTNET_COIN_ID=okb

# =====================================
# Gas Price Strategy Configuration
# =====================================
# Controls how to obtain gas price:
# - static: Use configured fixed values (requires manual updates)
# - dynamic: Query from RPC in real-time (calls every calculation, slow but most accurate)
# - hybrid: Background periodic cache updates (recommended, fast and accurate)
#
# Default behavior:
# - If any *_TARGET_GAS_PRICE is set, uses static
# - Otherwise uses hybrid (automatically fetches from chain)
#
# GAS_PRICE_STRATEGY=hybrid  # static | dynamic | hybrid

# Cache configuration (only for hybrid/dynamic strategies)
# GAS_PRICE_CACHE_TTL=300  # Cache validity (seconds), default 5 minutes
# GAS_PRICE_UPDATE_INTERVAL=60  # Background update interval (seconds), default 1 minute

# RPC URL configuration (for dynamic gas price fetching)
# If not set, will automatically retrieve from viem chains definitions
# Testnet (optional, has defaults)
# BASE_SEPOLIA_RPC_URL=https://sepolia.base.org
# X_LAYER_TESTNET_RPC_URL=https://testrpc.xlayer.tech
# Mainnet (optional, has defaults from viem)
# BASE_RPC_URL=https://mainnet.base.org
# X_LAYER_RPC_URL=https://rpc.xlayer.tech

# =====================================
# Gas Cost Configuration Explained
# =====================================
# 
# Fee calculation formula:
# 1. Gas Limit = BASE_LIMIT + HOOK_OVERHEAD
# 2. Gas Cost (Native) = Gas Limit × Gas Price (dynamic or static)
# 3. Gas Cost (USD) = Gas Cost (Native) × Native Token Price
# 4. Facilitator Fee = Gas Cost (USD) × Safety Multiplier
# 5. Convert to USDC smallest unit (× 10^6)
#
# Example (Base Sepolia + TransferHook, hybrid strategy):
# - Gas Price: Fetched from chain in real-time (e.g., 1.5 gwei)
# - Gas: (150k + 50k) × 1.5 gwei = 0.0003 ETH
# - USD: 0.0003 ETH × $3000 = $0.900000
# - With safety (1.5x): $0.900000 × 1.5 = $1.350000
# - USDC: $1.350000 × 10^6 = 1,350,000 (1.35 USDC)
#
# Example (X-Layer Testnet + TransferHook, static strategy):
# - Gas Price: 0.1 gwei (configured fixed value)
# - Gas: (150k + 50k) × 0.1 gwei = 0.00002 OKB
# - USD: 0.00002 OKB × $50 = $0.001000
# - With safety (1.5x): $0.001000 × 1.5 = $0.001500
# - USDC: $0.001500 × 10^6 = 1,500 (0.0015 USDC)
#
# Security protection layers:
# 1. Hook whitelist: Blocks unknown Hooks
# 2. Gas limit cap: Protection even for whitelisted Hooks
# 3. Fee validation: Ensures fees are sufficient to cover costs
#
# Production recommendations:
# - GAS_PRICE_STRATEGY=hybrid (automatically adapts to market prices)
# - HOOK_WHITELIST_ENABLED=true (strongly recommended for production)
# - GAS_COST_VALIDATION_ENABLED=true (required)
# - Configure RPC URLs to support dynamic gas price
# - Only add audited Hooks to whitelist
# - Periodically update native token prices
# - Monitor actual gas usage and adjust configuration

# =====================================
# OpenTelemetry Configuration (Optional)
# =====================================
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
# OTEL_EXPORTER_OTLP_HEADERS=
# OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
# OTEL_SERVICE_NAME=x402-facilitator
# OTEL_SERVICE_VERSION=0.1.0
# OTEL_SERVICE_DEPLOYMENT=production

# =====================================
# Logging Configuration
# =====================================
# LOG_LEVEL=info  # trace | debug | info | warn | error | fatal

# =====================================
# Performance Tuning Notes
# =====================================
# 1. Account count recommendations:
#    - 5 accounts: Suitable for most scenarios (~0.4 TPS, 1400+ transactions/hour)
#    - 10 accounts: High traffic scenarios (~0.8 TPS, 2800+ transactions/hour)
#    - Single account: Low traffic or testing environments
#
# 2. Cache strategy:
#    - Token version cache hit rate should be > 80%
#    - Recommend enabling cache to reduce RPC calls
#    - Automatically falls back to RPC queries on cache failures
#
# 3. Gas management:
#    - Periodically check account balances
#    - Recommend setting up auto-refill mechanism
#    - Use /ready endpoint to monitor gas balances
#
# 4. Monitoring metrics:
#    - facilitator.account.queue_depth - Queue depth
#    - facilitator.account.tx_count - Transaction count
#    - facilitator.cache.hit/miss - Cache hit rate
#    - facilitator.settle.duration_ms - Settlement latency

# =====================================
# Security Notes
# =====================================
# 1. NEVER commit .env to git!
# 2. Keep your private keys secure
# 3. Only add trusted SettlementRouter addresses to the whitelist
# 4. Validate all addresses before adding them
# 5. Use different accounts for different environments (dev/staging/prod)
# 6. Regularly rotate private keys
# 7. Monitor account activity for suspicious transactions
# 8. Enable rate limiting in production (RATE_LIMIT_ENABLED=true)
# 9. Set appropriate request body limits to prevent DoS attacks
# 10. Consider using secret management systems (KMS/Vault) for production
